# Content trust in Docker
- When transferring data among networked systems, trust is a central concern. 
- In particular, when communicating over an untrusted medium such as the internet, it is critical to ensure the integrity and the publisher of all the data a system operates on. 
- You use the Docker Engine to push and pull images (data) to a public or private registry. 
-  Content trust gives you the ability to verify both the integrity and the publisher of all the data received from a registry over any channel.
# About Docker Content Trust (DCT)
- Docker Content Trust (DCT) provides the ability to use digital signatures for data sent to and received from remote Docker registries.
- These signatures allow client-side or runtime verification of the integrity and publisher of specific image tags.
- Through DCT, image publishers can sign their images and image consumers can ensure that the images they use are signed. 
- Publishers could be individuals or organizations manually signing their content or automated software supply chains signing content as part of their release process.
# Image tags and DCT
An individual image record has the following identifier:
```
[REGISTRY_HOST[:REGISTRY_PORT]/]REPOSITORY[:TAG]
```
- A particular image REPOSITORY can have multiple tags. 
- For example, latest and 3.1.2 are both tags on the mongo image.
- An image publisher can build an image and tag combination many times changing the image with each build.
- DCT is associated with the TAG portion of an image. 
- Each image repository has a set of keys that image publishers use to sign an image tag. 
- Image publishers have discretion on which tags they sign.
- An image repository can contain an image with one tag that is signed and another tag that is not. 
- For example, consider the Mongo image repository. The latest tag could be unsigned while the 3.1.6 tag could be signed. 
- It is the responsibility of the image publisher to decide if an image tag is signed or not. 
- In this representation, some image tags are signed, others are not:
![](https://docs.docker.com/engine/security/trust/images/tag_signing.png)
- Publishers can choose to sign a specific tag or not. 
- As a result, the content of an unsigned tag and that of a signed tag with the same name may not match. 
- For example, a publisher can push a tagged image someimage:latest and sign it. 
- Later, the same publisher can push an unsigned someimage:latest image. 
- This second push replaces the last unsigned tag latest but does not affect the signed latest version. 
- The ability to choose which tags they can sign, allows publishers to iterate over the unsigned version of an image before officially signing it.
- Image consumers can enable DCT to ensure that images they use were signed. 
- If a consumer enables DCT, they can only pull, run, or build with trusted images. 
- Enabling DCT is a bit like applying a “filter” to your registry. 
- Consumers “see” only signed image tags and the less desirable, unsigned image tags are “invisible” to them.
# Docker Content Trust Keys
- Trust for an image tag is managed through the use of signing keys. 
- A key set is created when an operation using DCT is first invoked. 
- A key set consists of the following classes of keys:
1. an offline key that is the root of DCT for an image tag
2. repository or tagging keys that sign tags
3. server-managed keys such as the timestamp key, which provides freshness security guarantees for your repository
The following image depicts the various signing keys and their relationships:
![](https://docs.docker.com/engine/security/trust/images/trust_components.png)
-  Loss of the root key is very difficult to recover from.
- Correcting this loss requires intervention from Docker Support to reset the repository state.
- This loss also requires manual intervention from every consumer that used a signed tag from this repository prior to the loss.
# Signing Images with Docker Content Trust
- Within the Docker CLI we can sign and push a container image with the `$ docker trust` command syntax. 
- This is built on top of the `Notary` feature set
- A prerequisite for signing an image is a Docker Registry with a Notary server attached (Such as the Docker Hub or Docker Trusted Registry).
- To sign a Docker Image you will need a delegation key pair. 
- These keys can be generated locally using `$ docker trust key generate`, generated by a certificate authority
- if you are using Docker Enterprise’s Universal Control Plane (UCP), a user’s Client Bundle provides adequate keys for a delegation. 
- First we will add the delegation private key to the local Docker trust repository. (By default this is stored in ~/.docker/trust/). 
- If you are generating delegation keys with `$ docker trust key generate`, the private key is automatically added to the local trust store. 
- If you are importing a separate key, such as one from a UCP Client Bundle you will need to use the $ docker trust key load command.
```
docker trust key generate jeff
```
Or if you have an existing key:
```
docker trust key load key.pem --name jeff
```
- Next we will need to add the delegation public key to the Notary server
- This is specific to a particular image repository in Notary known as a Global Unique Name (GUN)
-  If this is the first time you are adding a delegation to that repository, this command will also initiate the repository, using a local Notary canonical root key. 
- To understand more about initiating a repository, and the role of delegations, head to delegations for content trust.
```
docker trust signer add --key cert.pem jeff dtr.example.com/admin/demo
```
Finally, we will use the delegation private key to sign a particular tag and push it up to the registry.
```
docker trust sign dtr.example.com/admin/demo:1
```
Alternatively, once the keys have been imported an image can be pushed with the `$ docker push command`, by exporting the DCT environmental variable.
```
export DOCKER_CONTENT_TRUST=1
docker push dtr.example.com/admin/demo:1
```
Remote trust data for a tag or a repository can be viewed by the `$ docker trust inspect` command:
```
docker trust inspect --pretty dtr.example.com/admin/demo:1
```
Remote Trust data for a tag can be removed by the `$ docker trust revoke` command:
```
docker trust revoke dtr.example.com/admin/demo:1
```
# Runtime Enforcement with Docker Content Trust
- This only applies to Docker Enterprise Engine 18.09 or newer
- Docker Content Trust within the Docker Enterprise Engine prevents a user from using a container image from an unknown source
- It will also prevent a user from building a container image from a base layer from an unknown source. 
- Trusted sources could include Official Docker Images, found on the Docker Hub, or User trusted sources, with repositories and tags signed with the commands above.
Engine Signature Verification prevents the following:
- `docker container run` of an unsigned or altered image
- `docker pull` of an unsigned or altered image.
- `docker build` where the `FROM` image is not signed or is not scratch
# Enabling DCT within the Docker Enterprise Engine
```
{
    "content-trust": {
        "mode": "enforced"
    }
}
```
# Official Docker images
```
{
  "content-trust": {
    "trust-pinning": {
      "official-library-images": true
    },
    "mode": "enforced"
  }
}
```
# User-Signed images
There are two options for trust pinning user-signed images:
- Notary Canonical Root Key ID (DCT Root Key) is an ID that describes just the root key used to sign a repository (or rather its respective keys). 
- Notary Root key ID (DCT Certificate ID) is an ID that describes the same, but the ID is unique per repository. 
# Using DCT in an offline environment
If your engine is unable to communicate to the registry, we can enable DCT to trust cached signature data. This is done through the allow-expired-cached-trust-data variable
# Client Enforcement with Docker Content Trust
- Currently, content trust is disabled by default in the Docker Client.
- To enable it, set the DOCKER_CONTENT_TRUST environment variable to 1
- This prevents users from working with tagged images unless they contain a signature.






